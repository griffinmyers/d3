<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>d3</title>

    <script src="bower_components/d3/d3.js" charset="utf-8"></script>
    <script src="bower_components/lodash/dist/lodash.js" charset="utf-8"></script>

    <style type="text/css">
      .node rect {
        fill: #ecf0f1;
        stroke: white;
        stroke-width: 1px;
        cursor: pointer;
      }

      .node {
        font: 10px monospace;
      }

      .link {
        fill: none;
        stroke: #7f8c8d;
        stroke-width: 1px;
      }
    </style>

  </head>
<body>

  <div id="nodes" style="position: absolute; top: 0; bottom: 0; left: 0; right: 0"/>

  <script type="text/javascript">

    var width = document.getElementById('nodes').clientWidth;
    var height = document.getElementById('nodes').clientHeight;

    var cluster = d3.layout.cluster()
      .size([width - 70, height - 70]);

    var diagonal = d3.svg.diagonal()
      .projection(function(d) { return [d.x, d.y] });

    var svg = d3.select('#nodes').append('svg')
      .attr('height', height)
      .attr('width', width)
      .append('g')
      .attr('transform', 'translate(0, 30)');

    d3.json("multi.json", function(error, n) {

      function parse_nodes(r, n, used_children) {
        if(_.isUndefined(used_children)) {
          used_children = {}
        }

        if(_.has(r, 'original_children')) {
          r.children = _.reduce(r.original_children, function(agg, c) {
            if(_.isUndefined(used_children[c])) {
              used_children[c] = used_children[c] + 1 || 1;
              return agg.concat(parse_nodes(n.nodes[c], n, used_children));
            }

            return agg;
          }, []);
        }

        return r;
      }

      function parse_links(r, n, agg) {
        if(_.isUndefined(agg)) {
          agg = [];
        }

        if(_.has(r, 'original_children')) {
          return _.flatten(agg.concat(_.map(r.original_children, function(c) {
            return parse_links(n.nodes[c], n, agg).concat({source: r, target: n.nodes[c]});
          })));
        }

        return agg;
      }

      function links_in_root_paths(node, n, agg) {
        if(_.isUndefined(agg)) {
          agg = [];
        }

        if(!_.isNull(node, 'parents')) {
          return _.flatten(agg.concat(_.map(node.parents, function(p) {
            return links_in_root_paths(n.nodes[p], n, agg).concat({source_id: p, target_id: node.id});
          })));
        }

        return agg;
      }

      function on_mouseover(node) {
        svg.selectAll('.link')
          .attr('style', function(link) {
            var root_paths = _.indexBy(links_in_root_paths(node, n), function(l) { return l.source_id + '|' + l.target_id} )
            if(_.has(root_paths, link.source.id + '|' + link.target.id)) {
              return 'stroke: #2ecc71;';
            }
            else {
              return 'stroke: #ecf0f1;';
            }
          });

        d3.event.stopPropagation();
      }

      function on_mouseout() {
        svg.selectAll('.link')
          .attr('style', 'stroke: #7f8c8d;');
      }

      var nodes = cluster.nodes(parse_nodes(n.nodes[0], n));
      var links = parse_links(n.nodes[0], n);

      var link = svg.selectAll('.link')
        .data(links)
        .enter().append('path')
        .attr('class', 'link')
        .attr('d', diagonal)

      var node = svg.selectAll('.node')
        .data(nodes)
        .enter().append('g')
        .attr('class', 'node')
        .attr('transform', function(d) { return 'translate(' + d.x + ', ' + d.y + ')'; });

      var guys = node.append('rect')
        .attr('width', 80)
        .attr('height', 20)
        .attr('transform', 'translate(-40, -15)')
        .on('mouseover', on_mouseover)
        .on('mouseout', on_mouseout);

      node.append('text')
        .attr('dx', 0)
        .attr('dy', -1)
        .attr("pointer-events", "none")
        .style('text-anchor', 'middle')
        .text(function(d) { return d.name; });
    });

  </script>

</body>
</html>
