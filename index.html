<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>d3</title>

    <script src="bower_components/d3/d3.js" charset="utf-8"></script>
    <script src="bower_components/lodash/dist/lodash.js" charset="utf-8"></script>

    <style type="text/css">
      .node rect {
        fill: #fff;
        stroke: steelblue;
        stroke-width: 1px;
      }

      .node {
        font: 10px sans-serif;
      }

      .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 1.5px;
      }
    </style>

  </head>
<body>

  <div id="nodes" style="width:100%; height:500px"/>

  <script type="text/javascript">

    var width = document.getElementById('nodes').clientWidth;
    var height = document.getElementById('nodes').clientHeight;

    var cluster = d3.layout.cluster()
      .size([width - 100, height - 200]);

    var diagonal = d3.svg.diagonal()
      .projection(function(d) { return [d.x, d.y] });

    var svg = d3.select('#nodes').append('svg')
      .attr('height', height)
      .attr('width', width)
      .append('g')
      .attr('transform', 'translate(0, 60)');

    d3.json("multi.json", function(error, n) {

      function parse_nodes(r, n, used_children) {
        if(_.isUndefined(used_children)) {
          used_children = {}
        }

        if(_.has(r, 'original_children')) {
          r.children = _.reduce(r.original_children, function(agg, c) {
            if(_.isUndefined(used_children[c])) {
              used_children[c] = used_children[c] + 1 || 1;
              return agg.concat(parse_nodes(n.nodes[c], n, used_children));
            }

            return agg;
          }, []);
        }

        return r;
      }

      function parse_links(r, n, agg) {
        if(_.isUndefined(agg)) {
          agg = [];
        }

        if(_.has(r, 'original_children')) {
          return _.flatten(agg.concat(_.map(r.original_children, function(c) {
            return parse_links(n.nodes[c], n, agg).concat({source: r, target: n.nodes[c]});
          })));
        }

        return agg;
      }

      var nodes = cluster.nodes(parse_nodes(n.nodes[0], n));
      var links = parse_links(n.nodes[0], n);

      var link = svg.selectAll('.link')
        .data(links)
        .enter().append('path')
        .attr('class', 'link')
        .attr('d', diagonal)

      var node = svg.selectAll('.node')
        .data(nodes)
        .enter().append('g')
        .attr('class', 'node')
        .attr('transform', function(d) { return 'translate(' + d.x + ', ' + d.y + ')'; });

      node.append('rect')
        .attr('width', 100)
        .attr('height', 20)
        .attr('transform', 'translate(-50, -15)');

      node.append('text')
        .attr('dx', 0)
        .attr('dy', -1)
        .style('text-anchor', 'middle')
        .text(function(d) { return d.name; });
    });

  </script>

</body>
</html>
